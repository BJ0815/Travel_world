<section class="new-schedule bg-img">
  <div class="row no-gutters">
    <div class="col-md-8 ">
      <div id="map-bolck">
        <div id="gmap-search-block" class="d-flex">
          <div id="custom-search-input">
            <div class="input-group">
              <input id="content" type="text" class="form-control" placeholder="Search"/>
              <span class="input-group-btn" onclick="searchFromStr()">
                <%= octicon "search" ,:height => 24, :class => "right left" %>
              </span>
            </div>
          </div>      
        </div>
        <div id="map"><%=t("schedule.map_content")%></div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="sidebar-menu black-box">
        <div class="sort-button-list">
          <p class="map-note pl-3"><< <%=t("schedule.search.which are you prefer? making your wish")%></p>

          <div class="sort-items">
            <ul class="icons">
              <li><%= button_to '景點', '#', class: "btn button" %></li>
              <li><%= button_to '美食', '#', class: "btn button" %></li>
              <li><%= button_to '購物', '#', class: "btn button" %></li>
            </ul>
          </div>
        </div>
        <!-- 待選清單 -->
        <div id="places" class="results-list">
          <% current_wish.wish_items.order(:district).each do |item| %>
          <div id="<%= item.id %>" class="results-items">
            <div class="row">
              <div class="col-md-5">
                <div class="image-result">
                  <!-- spot-image  -->
                  <a href="#" class="featured"><img src="https://images.unsplash.com/photo-1490380169520-0a4b88d52565?ixlib=rb-0.3.5&ixid=eyJhcHBfaWQiOjEyMDd9&s=bcf37734e59a40b36cd5ed71da95b206&auto=format&fit=crop&w=1950&q=80" alt="" /></a>
                </div>
              </div>
              <div class="col-md-7">
                <div class="item-info">
                  <header>
                    <h5><%= item.spot_name%></h5>
                  </header>
                  <footer>
                    <button type="button" class=" btn button">Learing more</button>
                    <i class="far fa-trash-alt delete-wishspot"></i>
                  </footer>
                </div>
              </div>
            </div>
          </div>
          <%end%>
          <div class="manage-list">
            <%= link_to t("schedule.search.start_planning"), new_event_schedule_path,method: :get, class: "btn btn-style"%>
            <%= link_to t("schedule.new.Save Your Trip"), new_user_session_path(session[:event]), class: "tbtn btn-blue" %>
          </div>
        </div>
      </div>
      <!-- <div class="footer-btn">
        <button type="button" class="btn btn-primary"><%=t("schedule.new.email")%></button>
        <button type="button" class="btn btn-primary"><%=t("schedule.new.print")%></button>
        <%= link_to t("schedule.new.view"), event_path(@event.id) ,method: :get, class: "tbtn btn-blue"%>
      </div> -->
    </div>
  </div>
</section>

  <!-- Modal -->
  <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel"><%=t("schedule.spot info")%></h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body" id="newpage"></div>

      </div>
    </div>
  </div>

  <script type="text/javascript">
    var currentInfoWindow = null;
    function initialize(spots) {
      var location = {
        lat: 44.5403,
        lng: -78.5463
      }

      if (spots.length > 0) {
        location = {
          lat: spots[0].lat,
          lng: spots[0].lng
        }
      }

      var map = new google.maps.Map(document.getElementById('map'), {
        center: location,
        zoom: 12
      });

      var marker;

      spots.forEach(function (spot) {
        //console.log(spot.lat) if(spot.rating > 4){
        marker = new google.maps.Marker({
          position: {
            lat: spot.lat,
            lng: spot.lng
          },
          map: map
        });

        attachSecretMessage(
          marker,
          "<h6>" + spot.spot_name + "</h6><div id ='rating'>" + spot.rating + "</div><img id='small-pic'><br>" + spot.address + "<br><button onclick='addSpotToDetails()' data-toggle='modal' data-target='#exampleModal'>加入<i class='fas fa-plus'></i></button><div hidden id='place'>" + spot.place_id + "</div>",
          spot.place_id,
          map
        )
        // }
      })

    }
    function attachSecretMessage(marker, secretMessage, placeId, map) {
      //console.log(placeId);
      var infowindow;

      marker.addListener('click', function () {
        if (currentInfoWindow != null) {
          currentInfoWindow.close();
        }
        map.setZoom(14);
        map.setCenter(marker.getPosition());
        infowindow = new google.maps.InfoWindow({
          content: "<div class='map_price' id='spot-info'>" + secretMessage + "<br></div>"
        });
        getPhoto(placeId);

        infowindow.open(marker.get('map'), marker);
        currentInfoWindow = infowindow;
      });

    }

    function getPhoto(placeId) {
      var url;
      //console.log(placeId.innerText); console.log(placeId);
      $.ajax({
        url: "/schedules/get_spot_phtot?place_id=" + placeId,
        method: "GET",
        dataType: "json",
        success: function (data) {
          url = data["url"];

          var smallSpot = document.getElementById("small-pic");
          smallSpot.setAttribute("src", url);
          //var spot = document.getElementById("spot-pic"); spot.setAttribute("src", url);

          $("#fancyboxPic").attr("href", url);
        }
      });

    }

    //default onload
    google.maps.event.addDomListener(window, 'load', function () {
      initialize(<%= raw @wishLists.to_json %>)
      showList();
    });

    $(function () {
      $('.sortable').sortable();
    });

    $(function () {

      $("#btnForm").fancybox({
        'scrolling': 'auto',
        'hideOnOverlayClick': false,
        'overlayOpacity': 0,
        'autoScale': false,
        'showCloseButton': true,
        'onStart': function () {
          $("#divForm").css("display", "block");
        },
        'onClosed': function () {
          $("#divForm").css("display", "none");
        }
      });

      $("a.fancybox").fancybox({
        'titlePosition': 'over',
        'overlayColor': '#000',
        'overlayOpacity': 0.8,
        'transitionIn': 'elastic',
        'transitionOut': 'elastic',
        'autoScale': true,
        'width': 900,
        'height': 900,
        'type': 'image'
      });
    });

    //open new detail
    function addSpotToDetails() {
      var scheduleId = $('div.bhoechie-tab-content.active').attr('id');
      var placeId = $("#place").html();
     scheduleId =  scheduleId.split("-").pop();
     // console.log(scheduleId);

      $.ajax({
        url: "/details/new",
        method: "GET",
        dataType: "HTML",
        data: {
          schedule_id: scheduleId,
          place_id: placeId
        },
        error: function (xhr) {
         $('#newpage').html("請先選擇第幾天");
        },
        success: function (data) {
          $('#newpage').html(data);

        }
      });

    }



    function showList() {
      $.ajax({
        url: "/wishes/" + <%=current_wish.id%>,
        method: "GET",
        dataType: "HTML",

        error: function (xhr) {
          //$('#newpage').html("ERROR");
          alert('Error');
        },
        success: function (data) {
          $('#wish-content').html(data);

        }
      });
    }
    //$("#todolist").on("click", ".delete-todo", function(e) {
    function showScheduleList(event) {
      //var id = $(".day-title").attr('id');
      var id = event.target.id;
      //e.target.parentNode.parentNode.id;
      console.log(id);

      $.ajax({
        url: "/schedules/" + id,
        method: "GET",
        dataType: "HTML",

        error: function (xhr) {
          //$('#newpage').html("ERROR");
          alert('請再點選一次');
        },
        success: function (data) {

          //$("schedule-"+id).find('.schedule-content').html(data);
          $("#schedule-content-" + id).html(data);

        }
      });
    }
    //show detail
    function showMoreInfo(event){

      var id = event.target.parentNode.parentNode.id;
       id =  id.split("-").pop();
      console.log(id);
        $.ajax({
        url: "/details/" + id,
        method: "GET",
        dataType: "HTML",

        error: function (xhr) {
          $('#newpage').html("ERROR");
          //alert('請再點選一次');
        },
        success: function (data) {
          $('#newpage').html(data);
        }
      });
    }

    //edit detail
    function editDetail(event){

      var id = event.target.parentNode.parentNode.id;
      var scheduleId = $('div.bhoechie-tab-content.active').attr('id');
      var placeId = $("#place").html();

     scheduleId =  scheduleId.split("-").pop();
     id =  id.split("-").pop();
      console.log(id);
        $.ajax({
        url: "/details/" + id + "/edit",
        method: "GET",
        dataType: "HTML",
        data: {
          schedule_id: scheduleId,
          place_id: placeId
        },

        error: function (xhr) {
          $('#newpage').html("ERROR");
          //alert('請再點選一次');
        },
        success: function (data) {
          $('#newpage').html(data);
        }
      });
    }
  </script>
  <script type="text/template" id="spot-template">
    <td class="item-list"></td>
    <td>
      <span class="delete-wishspot">Delete</span>
    </td>
  </script>

  <script type="text/template" id="spot-add-template">
    <center>
      <div class="conteaner"></div>
    </center>
  </script>
